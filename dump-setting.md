---
title: UWF を有効化した環境でメモリ ダンプを取得する方法
date: 2020-02-12 00:00:00
categories:
- Unified Write Filter
tags:
- メモリ ダンプの設定手順
---

UWF を有効化した環境で、メモリ ダンプを取得する方法についてご紹介します。
<!-- more -->
<br>

***
## はじめに

### 概要
強制メモリ ダンプを取得することで、現象発生時のメモリの状態を Memory.dmp ファイルとして保存し、そこから現象発生時のオペレーティング システムのメモリの状態や、行われていた処理などの詳細を確認することができます。  

### 影響
正規の手順でシャットダウンさせることにはならないため、最悪の場合、Dump ファイルの採取によって、システムに必要なファイルが破損するなどの致命的な問題を引き起こす可能性がありますことを、予めご留意ください。  

### 再起動の必要性
事前準備時、メモリダンプ採取時に再起動が必要です。  

### 採取ファイル
本手順では "D:\Dumps\Memory.dmp" として進めさせていただきます。  
***
## 事前準備
- システム ドライブ以外に、メモリ ダンプを保存するボリュームを追加し、いずれかのドライブとしてマウントします。  
※ この手順では D: ドライブとします。  
<br>
- 事前に UWF フィルターとボリュームの保護を実行します。この過程で PageFile の設定が一旦初期化されます。  
実行例:  
uwfmgr.exe filter enable  
uwfmgr.exe volume protect c:  
shutdown -r -t 0  
※ この手順ではシステム ドライブを C: ドライブとします。
***
## 手順
1. UWF フィルターを無効化する。  
実行例:  
uwfmgr.exe filter disable  
<br>  
2. PageFile の大きさを 物理メモリ + 300 Mbyte 以上の大きさに設定する。  
実行例:  
a) [エクスプローラ] - [コンピュータ] を右クリックし [プロパティ(R)] をクリックします。  
b) [システムの詳細設定] をクリックします。  
c) [詳細設定] タブの [パフォーマンス] にある [設定(S)] をクリックします。  
d) [詳細設定] タブの [仮想メモリ] の項目にある [変更(C)] ボタンをクリックします。  
e) この画面にて、[すべてのドライブのページング ファイルのサイズを自動的に管理する(A)] オプションを外します。  
f) 手順 1) で作成したシステムドライブ以外のドライブ (ここでは D:\) をクリックします。  
g) [カスタムサイズ] にチェックを付け、[初期サイズ]、[最大サイズ] の両方に物理メモリ + 300 Mbyte 以上の値を入力します。 (例えば 4096MB メモリの場合、4396MB)  
h) その後 [設定] ボタンをクリックし設定を反映させ [OK] ボタンをクリックします。  
i) "変更結果はコンピューターを再起動しなければ有効になりません。" というポップアップが表示されますので、[OK] ボタンをクリックします。  
j) "パフォーマンス オプション" のウィンドウも [OK] ボタンにて閉じます。  
<br>
※ 補足  
この設定値は、次のレジストリに反映されます。なお、直接レジストリ値を編集することでも、ページング ファイル サイズを設定することができます。  
<br>
キー: HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SessionManager\MemoryManagement  
名前: PagingFiles  
種類: REG_MULTI_SZ  
データ: <ページ ファイル保存先> <初期サイズ (MB)> <最大サイズ (MB)> (設定例: d:\pagefile.sys 4396 4396)  
<br>
3. 完全メモリ ダンプ (Full Dump) が生成される設定にします。  
a) [エクスプローラ] - [コンピュータ] を右クリックし、[プロパティ] をクリックします。  
b) 左ペインにある [システムの詳細設定] をクリックします。  
c) "システムのプロパティ" の [詳細設定] タブの [起動と回復] 枠内にある [設定] ボタンをクリックします。  
d) "起動と回復" の [デバッグ情報の書き込み] 枠内にあるプルダウン メニューから [完全メモリ ダンプ] を選択し、[OK] ボタンを 2 回クリックします。  
<br>
4. [ダンプ ファイル] のパスを変更します。  
<br>
※ 注意  
GUI から [完全メモリ ダンプ] を選択する事と併せて、以下のレジストリ エディタで、次のレジストリの値が設定されている事をご確認ください。  
<br>
キー: HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\CrashControl  
名前: CrashDumpEnabled  
種類: REG_DWORD  
データ: 1  
<br>
メモリ ダンプの出力先は、次のレジストリ値で確認できます。  
<br>
キー: HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\CrashControl  
名前: DumpFile  
種類: REG_EXPAND_SZ  
データ(既定値): D:\Dumps\MEMORY.DMP  

***